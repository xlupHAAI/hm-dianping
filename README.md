#### 工作日志

2026.01.13	ver1.1 实现登录注册模块

1. 使用 Redis 保存登录验证码以及用户 token，解决 Session 共享问题；
2. 使用双层拦截器对用户 token 做校验和刷新；
3. 拦截器在每次用户请求到来时将 token 保存到 ThreadLocal，并在请求处理完成后释放之；
4. 问题遗留：目前并不能真正地向用户发送验证码，后续尝试使用邮箱或短信发送。（⚪）

2026.01.14	ver1.2.1 为商户信息查询添加了 Redis 缓存

1. DB 和缓存的双写采用 Cache Aside 策略，用 Spring 事务保证每次写入时 DB 和缓存更新的原子性；

2. 双写时先更新 DB，再删除缓存，减少不一致的可能持续时间，同时用 TTL 超时删除兜底，保证最终一致性；

3. 采用缓存空值策略防止缓存穿透，对于热点商户采用逻辑过期方案防止缓存击穿；

4. 问题遗留：

   - 如何区分热点商户和普通商户？暂未实现；（√）

   - Cache Aside 不保证双写强一致，是否有必要使用分布式锁或延迟双删？（⚪）

     > 例：某个商户在缓存中的信息到达 TTL，被 Redis 剔除，此时 thread A 更新（写）这个商户，thread B 读这个商户
     >
     > A 更新 DB ——> B 读缓存未命中，读 DB ——> A 删缓存 ——> B 将读到的 stale 数据写入缓存，**造成缓存与 DB 不一致**。

   - 不能很好地应对缓存雪崩或 Redis 服务不可用，后续尝试添加多级缓存。（⚪）

2026.01.15	ver1.2.2 添加了区分热点商户的简单策略

1. 现在可以简单区分热点商户了，对普通商户采用缓存空值避免缓存穿透，对热点商户采用逻辑过期防止缓存击穿；
2. 暂时使用评论数量区分热点商家，但实际业务应使用带有时间特征的指标，例如近期的被浏览数、被搜索数，目前没有维护这些时间相关特征。

2026.01.17	ver1.3.1 开始实现秒杀模块基本功能

1. 基于 Redis 自增生成订单的全局唯一 ID，考虑到方便统计订单数量因此没有采用 JDK 的 UUID，考虑到时钟回拨没有使用雪花算法；
2. 使用乐观锁思想解决库存超卖，利用 MySQL 行操作的原子性仅当库存有剩余时扣减，即`set ... where stock > 0`；对于更复杂的业务场景，可以使用版本号法或分布式锁保证线程安全，也可以通过水平分表 + 分段锁细化锁的粒度；
3. 目前还没有上缓存，用 JMeter 初步测试吞吐量每秒 350+，且无超卖发生。
